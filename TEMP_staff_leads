<x-app-layout>
  <x-slot name="header">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold text-xl text-gray-800 leading-tight">Leads</h2>
      <form action="{{ route('staff.leads') }}" method="GET" class="text-sm flex items-end gap-2">
        <div>
          <label class="block text-gray-600">Stage</label>
          <select name="stage" class="mt-1 rounded border p-2">
            <option value="">All</option>
            @foreach(['new','contacted','qualified','won','lost'] as $s)
              <option value="{{ $s }}" @selected(request('stage')===$s)>{{ ucfirst($s) }}</option>
            @endforeach
          </select>
        </div>
        <div>
          <label class="block text-gray-600">Status</label>
          <select name="status" class="mt-1 rounded border p-2">
            <option value="">All</option>
            @foreach(['open','closed'] as $s)
              <option value="{{ $s }}" @selected(request('status')===$s)>{{ ucfirst($s) }}</option>
            @endforeach
          </select>
        </div>
        <div>
          <label class="block text-gray-600">From</label>
          <input type="date" name="from" value="{{ request('from') }}" class="mt-1 rounded border p-2" />
        </div>
        <div>
          <label class="block text-gray-600">To</label>
          <input type="date" name="to" value="{{ request('to') }}" class="mt-1 rounded border p-2" />
        </div>
        <button class="rounded bg-emerald-600 px-4 py-2 text-white font-semibold">Filter</button>
      </form>
    </div>
  </x-slot>

  <div class="py-8">
    <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 space-y-6">
      <div class="bg-white p-6 shadow sm:rounded-lg">
        <form action="{{ route('staff.leads') }}" method="POST" class="grid md:grid-cols-5 gap-3 text-sm">
          @csrf
          <div>
            <label class="block text-gray-600">Name</label>
            <input name="name" class="mt-1 w-full rounded border p-2" required />
          </div>
          <div>
            <label class="block text-gray-600">Email</label>
            <input name="email" class="mt-1 w-full rounded border p-2" />
          </div>
          <div>
            <label class="block text-gray-600">Phone</label>
            <input name="phone" class="mt-1 w-full rounded border p-2" />
          </div>
          <div>
            <label class="block text-gray-600">Next follow-up</label>
            <input type="date" name="next_follow_up" class="mt-1 w-full rounded border p-2" />
          </div>
          <div class="flex items-end">
            <button class="rounded bg-emerald-600 px-4 py-2 text-white font-semibold">Add Lead</button>
          </div>
        </form>
      </div>

      <div class="bg-white shadow sm:rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stage / Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next Follow-up</th>
              <th class="px-6 py-3"></th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @forelse(($leads ?? []) as $lead)
              <tr>
                <td class="px-6 py-4 text-sm text-gray-900"><a href="{{ route('staff.leads.show', $lead->id) }}" class="text-indigo-700 hover:underline">{{ $lead->name }}</a>
                  @php($meta = json_decode($lead->notes, true))
                  @if(is_array($meta) && isset($meta['service_type']))
                    <div class="mt-1 text-xs text-gray-600">
                      @if(($meta['service_type'] ?? '')==='job')
                        Enquiry: Job @if(!empty($meta['job_id']))#{{ $meta['job_id'] }}@endif @if(!empty($meta['package_id']))(Pkg #{{ $meta['package_id'] }})@endif
                        @if(!empty($meta['experience_years'])) • {{ $meta['experience_years'] }} yrs exp @endif
                        @if(!empty($meta['available_from'])) • From {{ $meta['available_from'] }} @endif
                        @if(isset($meta['has_passport'])) • Passport: {{ $meta['has_passport'] ? 'Yes' : 'No' }} @endif
                      @else
                        Enquiry: Tour @if(!empty($meta['destination'])) • {{ $meta['destination'] }} @endif
                        @if(!empty($meta['start_date']) || !empty($meta['end_date'])) • {{ $meta['start_date'] ?? '?' }}→{{ $meta['end_date'] ?? '?' }} @endif
                        @if(isset($meta['adults']) || isset($meta['children'])) • {{ (int)($meta['adults'] ?? 0) }}A, {{ (int)($meta['children'] ?? 0) }}C @endif
                        @if(!empty($meta['budget'])) • Budget {{ $meta['budget'] }} @endif
                      @endif
                      @if(!empty($meta['message']))
                        <div class="truncate">“{{ \Illuminate\Support\Str::limit($meta['message'], 80) }}”</div>
                      @endif
                    </div>
                  @endif
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                  <div>{{ $lead->email }}</div>
                  <div class="text-xs text-gray-500">{{ $lead->phone }}</div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700 capitalize">{{ $lead->stage }} / {{ $lead->status }}</td>
                <td class="px-6 py-4 text-sm text-gray-700">{{ $lead->next_follow_up ? $lead->next_follow_up->format('Y-m-d') : '—' }}</td>
                <td class="px-6 py-4 text-sm text-right">
                  <form action="{{ route('staff.leads.note', $lead->id) }}" method="POST" class="inline">
                    @csrf
                    <input type="hidden" name="stage" value="{{ $lead->stage }}" />
                    <input type="hidden" name="status" value="{{ $lead->status }}" />
                    <input name="content" placeholder="Add note" class="rounded border p-1 text-sm w-48" />
                    <input type="date" name="next_follow_up" class="rounded border p-1 text-sm" />
                    <button class="rounded bg-slate-700 px-3 py-1.5 text-white text-sm">Save</button>
                  </form>
                </td>
              </tr>
            @empty
              <tr>
                <td colspan="5" class="px-6 py-6 text-sm text-gray-500">No leads yet.</td>
              </tr>
            @endforelse
          </tbody>
        </table>
      </div>
      @if(isset($leads))
        <div class="mt-4">{{ $leads->links() }}</div>
      @endif
    </div>
  </div>
</x-app-layout>

